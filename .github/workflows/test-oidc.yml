name: ğŸ§ª Test OIDC Authentication

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: read
  id-token: write

jobs:
  test-oidc:
    name: Test OIDC Authentication
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Test Azure Authentication
        run: |
          echo "ğŸ” Testing Azure CLI availability..."
          az version
          
          echo "ğŸ” Testing OIDC login..."
          # Login using OIDC with built-in support
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }} \
            --allow-no-subscriptions \
            --federated-token $ACTIONS_ID_TOKEN_REQUEST_TOKEN
          
          # Set subscription
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
          # Test authentication
          echo "âœ… Testing account access..."
          az account show --query '{name:name, id:id, tenantId:tenantId}' -o table
          
          echo "âœ… OIDC authentication successful!"

      - name: ğŸ§ª Test Permissions
        run: |
          echo "ğŸ§ª Testing managed identity permissions..."
          
          # Test listing resource groups
          echo "Testing resource group access..."
          az group list --query '[].name' -o table
          
          # Test listing storage accounts
          echo "Testing storage account access..."
          az storage account list --query '[].name' -o table
          
          echo "âœ… Permission tests completed!"

      - name: ğŸ“‹ Summary
        run: |
          echo "ğŸ“‹ Test Summary:"
          echo "â€¢ Environment: ${{ github.event.inputs.environment }}"
          echo "â€¢ Azure CLI: Available"
          echo "â€¢ OIDC Login: Successful"
          echo "â€¢ Permissions: Verified"
          echo "â€¢ Ready for backend setup: âœ…"
