name: ðŸ” Terraform Plan & Validation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to plan deployment for'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      destroy_plan:
        description: 'Generate destroy plan instead of apply plan'
        required: false
        type: boolean
        default: false
      detailed_output:
        description: 'Show detailed plan output in logs'
        required: false
        type: boolean
        default: true
  pull_request:
    paths:
      - 'infra/tf/**'
      - '.github/workflows/terraform-plan.yml'
    branches:
      - main
      - develop
  push:
    paths:
      - 'infra/tf/**'
    branches:
      - main

permissions:
  contents: read
  id-token: write
  pull-requests: write  # For PR comments
  issues: write         # For issue creation on failures

jobs:
  terraform-plan:
    name: Terraform Plan (${{ github.event.inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    env:
      TF_IN_AUTOMATION: true
      TF_VAR_environment: ${{ github.event.inputs.environment || 'dev' }}
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    
    outputs:
      plan_status: ${{ steps.plan.outputs.status }}
      plan_summary: ${{ steps.plan.outputs.summary }}
      validation_status: ${{ steps.validate.outputs.status }}
    
    steps:
      - name: ðŸ“¥ [1/10] Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: ðŸ” [2/10] Azure Login with OIDC
        run: |
          echo "=========================================="
          echo "ðŸ” STEP 2: AZURE OIDC AUTHENTICATION"
          echo "=========================================="
          echo "â±ï¸ Start time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸŽ¯ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 20%"
          echo ""
          
          START_TIME=$(date +%s)
          echo "â–¶ï¸ Authenticating with Azure using OIDC..."
          
          echo "ðŸ“‹ Authentication Configuration:"
          echo "â€¢ Client ID: ${{ secrets.AZURE_CLIENT_ID }}"
          echo "â€¢ Tenant ID: ${{ secrets.AZURE_TENANT_ID }}"
          echo "â€¢ Subscription ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          echo "â€¢ Authentication Method: OIDC Federation"
          echo ""
          
          # Get OIDC token
          echo "â–¶ï¸ Requesting OIDC token..."
          OIDC_TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange" | jq -r '.value')
          
          if [ "$OIDC_TOKEN" = "null" ] || [ -z "$OIDC_TOKEN" ]; then
            echo "âŒ Failed to get OIDC token"
            exit 1
          fi
          
          echo "âœ… OIDC token obtained successfully"
          
          # Login using OIDC
          echo "â–¶ï¸ Logging in to Azure..."
          az login --service-principal \
            --username ${{ secrets.AZURE_CLIENT_ID }} \
            --tenant ${{ secrets.AZURE_TENANT_ID }} \
            --allow-no-subscriptions \
            --federated-token "$OIDC_TOKEN"
          
          # Set subscription
          echo "â–¶ï¸ Setting subscription context..."
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
          # Verify authentication
          echo "â–¶ï¸ Verifying authentication..."
          az account show --query '{name:name, id:id, tenantId:tenantId}' -o table
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âœ… Azure authentication completed"
          echo "â±ï¸ Execution time: ${DURATION}s"
          echo "â±ï¸ End time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: ðŸ—ï¸ [3/10] Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.9.0"
          terraform_wrapper: false  # Disable wrapper for cleaner output

      - name: ðŸ” [4/10] Validate Terraform Configuration
        id: validate
        working-directory: infra/tf
        run: |
          echo "=========================================="
          echo "ðŸ” STEP 4: TERRAFORM CONFIGURATION VALIDATION"
          echo "=========================================="
          echo "â±ï¸ Start time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸŽ¯ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 40%"
          echo ""
          
          START_TIME=$(date +%s)
          echo "â–¶ï¸ Validating Terraform configuration..."
          
          echo "ðŸ“‹ Validation Checks:"
          echo "â€¢ Syntax validation"
          echo "â€¢ Configuration consistency"
          echo "â€¢ Provider requirements"
          echo "â€¢ Variable definitions"
          echo ""
          
          # Format check
          echo "â–¶ï¸ Checking Terraform formatting..."
          terraform fmt -check -recursive || {
            echo "âš ï¸ Terraform files are not properly formatted"
            echo "Run 'terraform fmt -recursive' to fix formatting"
            terraform fmt -diff -recursive
          }
          
          # Validation
          echo "â–¶ï¸ Running terraform validate..."
          terraform validate
          
          VALIDATION_STATUS=$?
          if [ $VALIDATION_STATUS -eq 0 ]; then
            echo "âœ… Terraform configuration is valid"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Terraform configuration validation failed"
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âœ… Terraform validation completed"
          echo "â±ï¸ Execution time: ${DURATION}s"
          echo "â±ï¸ End time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: ðŸ”§ [5/10] Initialize Terraform
        working-directory: infra/tf
        run: |
          echo "=========================================="
          echo "ðŸ”§ STEP 5: TERRAFORM INITIALIZATION"
          echo "=========================================="
          echo "â±ï¸ Start time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸŽ¯ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 50%"
          echo ""
          
          START_TIME=$(date +%s)
          echo "â–¶ï¸ Initializing Terraform..."
          
          echo "ðŸ“‹ Initialization Configuration:"
          echo "â€¢ Backend: Azure Storage"
          echo "â€¢ Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "â€¢ Working Directory: $(pwd)"
          echo ""
          
          # Initialize with backend
          echo "â–¶ï¸ Running terraform init..."
          terraform init -input=false
          
          # Show providers
          echo "â–¶ï¸ Checking provider versions..."
          terraform version
          terraform providers
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âœ… Terraform initialization completed"
          echo "â±ï¸ Execution time: ${DURATION}s"
          echo "â±ï¸ End time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: ðŸ” [6/10] Security Scan with Checkov
        working-directory: infra/tf
        continue-on-error: true  # Don't fail the workflow for security issues
        run: |
          echo "=========================================="
          echo "ðŸ” STEP 6: SECURITY SCANNING WITH CHECKOV"
          echo "=========================================="
          echo "â±ï¸ Start time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸŽ¯ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 60%"
          echo ""
          
          START_TIME=$(date +%s)
          echo "â–¶ï¸ Installing and running Checkov security scanner..."
          
          # Install Checkov
          pip3 install checkov
          
          echo "ðŸ“‹ Security Scan Configuration:"
          echo "â€¢ Scanner: Checkov"
          echo "â€¢ Target: Terraform files"
          echo "â€¢ Output: SARIF format for GitHub integration"
          echo ""
          
          # Run security scan
          echo "â–¶ï¸ Running security scan..."
          checkov -d . --framework terraform \
            --output cli \
            --output sarif \
            --output-file-path console,checkov-report.sarif || true
          
          # Check if SARIF file was created
          if [ -f "checkov-report.sarif" ]; then
            echo "âœ… Security scan completed - SARIF report generated"
            echo "ðŸ“Š Results saved to checkov-report.sarif"
          else
            echo "âš ï¸ Security scan completed - no SARIF report generated"
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âœ… Security scanning completed"
          echo "â±ï¸ Execution time: ${DURATION}s"
          echo "â±ï¸ End time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: ðŸ“‹ [7/10] Generate Terraform Plan
        id: plan
        working-directory: infra/tf
        run: |
          echo "=========================================="
          echo "ðŸ“‹ STEP 7: TERRAFORM PLAN GENERATION"
          echo "=========================================="
          echo "â±ï¸ Start time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸŽ¯ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 70%"
          echo ""
          
          START_TIME=$(date +%s)
          
          # Determine plan type
          if [ "${{ github.event.inputs.destroy_plan }}" = "true" ]; then
            PLAN_TYPE="destroy"
            PLAN_FLAG="-destroy"
            echo "â–¶ï¸ Generating DESTROY plan..."
            echo "âš ï¸ WARNING: This will plan the destruction of resources!"
          else
            PLAN_TYPE="apply"
            PLAN_FLAG=""
            echo "â–¶ï¸ Generating APPLY plan..."
          fi
          
          echo "ðŸ“‹ Plan Configuration:"
          echo "â€¢ Plan Type: $PLAN_TYPE"
          echo "â€¢ Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "â€¢ Detailed Output: ${{ github.event.inputs.detailed_output || 'true' }}"
          echo ""
          
          # Generate plan
          echo "â–¶ï¸ Running terraform plan..."
          terraform plan $PLAN_FLAG \
            -input=false \
            -out=tfplan \
            -detailed-exitcode \
            -var-file="terraform.tfvars" 2>&1 | tee plan-output.txt
          
          PLAN_EXIT_CODE=${PIPESTATUS[0]}
          
          # Analyze plan results
          case $PLAN_EXIT_CODE in
            0)
              PLAN_STATUS="no-changes"
              PLAN_SUMMARY="No changes required"
              echo "âœ… No changes detected"
              ;;
            1)
              PLAN_STATUS="error"
              PLAN_SUMMARY="Plan generation failed"
              echo "âŒ Plan generation failed"
              ;;
            2)
              PLAN_STATUS="changes"
              PLAN_SUMMARY="Changes detected"
              echo "ðŸ“ Changes detected in plan"
              ;;
            *)
              PLAN_STATUS="unknown"
              PLAN_SUMMARY="Unknown plan status"
              echo "âš ï¸ Unknown plan exit code: $PLAN_EXIT_CODE"
              ;;
          esac
          
          # Save outputs
          echo "status=$PLAN_STATUS" >> $GITHUB_OUTPUT
          echo "summary=$PLAN_SUMMARY" >> $GITHUB_OUTPUT
          
          # Show plan summary if detailed output is enabled
          if [ "${{ github.event.inputs.detailed_output }}" = "true" ] && [ -f "plan-output.txt" ]; then
            echo ""
            echo "ðŸ“‹ Plan Output Summary:"
            echo "----------------------------------------"
            # Show last 50 lines of plan for summary
            tail -50 plan-output.txt
            echo "----------------------------------------"
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âœ… Terraform plan generation completed"
          echo "ðŸ“Š Plan Status: $PLAN_STATUS"
          echo "ðŸ“ Summary: $PLAN_SUMMARY"
          echo "â±ï¸ Execution time: ${DURATION}s"
          echo "â±ï¸ End time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: ðŸ’¾ [8/10] Save Plan and Reports
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || 'dev' }}-${{ github.run_number }}
          path: |
            infra/tf/tfplan
            infra/tf/plan-output.txt
            infra/tf/checkov-report.sarif
          retention-days: 30

      - name: ðŸ“Š [9/10] Generate Plan Summary
        working-directory: infra/tf
        run: |
          echo "=========================================="
          echo "ðŸ“Š STEP 9: PLAN SUMMARY GENERATION"
          echo "=========================================="
          echo "â±ï¸ Start time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸŽ¯ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 90%"
          echo ""
          
          START_TIME=$(date +%s)
          echo "â–¶ï¸ Generating comprehensive plan summary..."
          
          # Generate detailed plan summary
          if [ -f "tfplan" ]; then
            echo "â–¶ï¸ Analyzing plan file..."
            terraform show -json tfplan > plan.json
            
            # Extract key metrics
            RESOURCES_TO_ADD=$(jq -r '.resource_changes[] | select(.change.actions[] == "create") | .address' plan.json 2>/dev/null | wc -l)
            RESOURCES_TO_CHANGE=$(jq -r '.resource_changes[] | select(.change.actions[] == "update") | .address' plan.json 2>/dev/null | wc -l)
            RESOURCES_TO_DESTROY=$(jq -r '.resource_changes[] | select(.change.actions[] == "delete") | .address' plan.json 2>/dev/null | wc -l)
            
            echo "ðŸ“Š Plan Statistics:"
            echo "â€¢ Resources to Add: $RESOURCES_TO_ADD"
            echo "â€¢ Resources to Change: $RESOURCES_TO_CHANGE"
            echo "â€¢ Resources to Destroy: $RESOURCES_TO_DESTROY"
            echo ""
            
            # Generate markdown summary
            cat > plan-summary.md << EOF
          # Terraform Plan Summary - ${{ github.event.inputs.environment || 'dev' }}
          
          ## Plan Overview
          
          **Environment**: ${{ github.event.inputs.environment || 'dev' }}
          **Plan Type**: ${{ github.event.inputs.destroy_plan == 'true' && 'Destroy' || 'Apply' }}
          **Generated**: $(date)
          **Workflow**: ${{ github.workflow }}
          **Run**: ${{ github.run_number }}
          **Status**: ${{ steps.plan.outputs.status }}
          
          ## Resource Changes
          
          | Action | Count |
          |--------|-------|
          | ðŸŸ¢ Add | $RESOURCES_TO_ADD |
          | ðŸŸ¡ Change | $RESOURCES_TO_CHANGE |
          | ðŸ”´ Destroy | $RESOURCES_TO_DESTROY |
          
          ## Validation Results
          
          - âœ… **Terraform Validation**: ${{ steps.validate.outputs.status }}
          - âœ… **Security Scan**: Completed (see artifacts)
          - âœ… **Plan Generation**: ${{ steps.plan.outputs.status }}
          
          ## Next Steps
          
          1. **Review Plan**: Download and review the plan artifacts
          2. **Security Review**: Check the Checkov security scan results
          3. **Approval**: Get necessary approvals for changes
          4. **Apply**: Use the apply workflow to execute changes
          
          ---
          
          Generated by: ${{ github.actor }}
          Commit: ${{ github.sha }}
          EOF
          
          else
            echo "âš ï¸ Plan file not found, generating basic summary..."
            cat > plan-summary.md << EOF
          # Terraform Plan Summary - ${{ github.event.inputs.environment || 'dev' }}
          
          **Status**: ${{ steps.plan.outputs.status }}
          **Summary**: ${{ steps.plan.outputs.summary }}
          **Generated**: $(date)
          
          Plan details are available in the workflow logs and artifacts.
          EOF
          fi
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo ""
          echo "âœ… Plan summary generated"
          echo "â±ï¸ Execution time: ${DURATION}s"
          echo "â±ï¸ End time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

      - name: ðŸ’¬ [9/10] Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './infra/tf/plan-summary.md';
            
            if (fs.existsSync(path)) {
              const summary = fs.readFileSync(path, 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ” Terraform Plan Results\n\n${summary}`
              });
            }

      - name: ðŸŽ‰ [10/10] Plan Complete
        run: |
          echo "=========================================="
          echo "ðŸŽ‰ STEP 10: WORKFLOW COMPLETION"
          echo "=========================================="
          echo "â±ï¸ Start time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸŽ¯ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%"
          echo ""
          
          echo "ðŸŽ‰ Terraform plan and validation completed successfully!"
          echo ""
          echo "ðŸ“‹ Summary:"
          echo "â€¢ Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "â€¢ Validation Status: ${{ steps.validate.outputs.status }}"
          echo "â€¢ Plan Status: ${{ steps.plan.outputs.status }}"
          echo "â€¢ Plan Summary: ${{ steps.plan.outputs.summary }}"
          echo ""
          echo "ðŸ“¦ Artifacts Generated:"
          echo "â€¢ Terraform plan file (tfplan)"
          echo "â€¢ Plan output logs"
          echo "â€¢ Security scan results (SARIF)"
          echo "â€¢ Plan summary report"
          echo ""
          echo "ðŸ”„ Next Steps:"
          echo "1. Review the plan artifacts and summary"
          echo "2. Check security scan results for any issues"
          echo "3. If satisfied, proceed with terraform apply workflow"
          echo "4. Monitor the deployment process"
          echo ""
          echo "âœ… Workflow completed successfully"
          echo "â±ï¸ End time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: failure()
    
    steps:
      - name: ðŸš¨ Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Terraform Plan Failed - ${{ github.event.inputs.environment || 'dev' }}`;
            const body = `
            ## Terraform Plan Failure Report
            
            **Environment**: ${{ github.event.inputs.environment || 'dev' }}
            **Workflow Run**: ${{ github.run_id }}
            **Triggered By**: ${{ github.actor }}
            **Commit**: ${{ github.sha }}
            
            ### Failure Details
            
            - **Validation Status**: ${{ needs.terraform-plan.outputs.validation_status }}
            - **Plan Status**: ${{ needs.terraform-plan.outputs.plan_status }}
            
            ### Action Required
            
            1. Review the workflow logs: [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Check for configuration errors or permission issues
            3. Fix the issues and re-run the workflow
            
            ### Troubleshooting
            
            - Check Azure permissions and OIDC configuration
            - Verify Terraform configuration syntax
            - Review security scan results if available
            
            ---
            
            This issue was automatically created by the Terraform Plan workflow.
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['terraform', 'deployment-failure', 'auto-created']
            });
